<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="black">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coolio Web</title>
  <link rel="icon" href="img/logo.png" type="image/png">
  <link rel="stylesheet" href="css/index.css">
</head>
<body>
<div class="container">
  <div class="tabs" id="tabs"></div>
  <div class="url-bar-wrapper">
    <button class="nav-button" id="backBtn"><svg class="navb-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
 <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
 </svg>
    </svg></button>
    <button class="nav-button" id="forwardBtn"><svg class="navb-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
 <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
 </svg></button>
    <button class="nav-button" id="reloadBtn"><svg class="navb-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
 <path d="M22 10C22 10 19.995 7.26822 18.3662 5.63824C16.7373 4.00827 14.4864 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.1031 21 19.5649 18.2543 20.6482 14.5M22 10V4M22 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
 </svg></button>
    <input id="url-input" class="url-bar" placeholder="Search or enter a URL.">
    <button class="more-button" id="moreButton"><svg class="navb-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
 <path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
 <path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
 <path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
 </svg></button>
  </div>
<div class="dropdown" id="dropdownMenu">
  <button id="newTabBtn">
    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    New Tab
  </button>

  <div class="divider"></div>

  <button id="fullscreenBtn">
    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 3H7.8C6.11984 3 5.27976 3 4.63803 3.32698C4.07354 3.6146 3.6146 4.07354 3.32698 4.63803C3 5.27976 3 6.11984 3 7.8V8M8 21H7.8C6.11984 21 5.27976 21 4.63803 20.673C4.07354 20.3854 3.6146 19.9265 3.32698 19.362C3 18.7202 3 17.8802 3 16.2V16M21 8V7.8C21 6.11984 21 5.27976 20.673 4.63803C20.3854 4.07354 19.9265 3.6146 19.362 3.32698C18.7202 3 17.8802 3 16.2 3H16M21 16V16.2C21 17.8802 21 18.7202 20.673 19.362C20.3854 19.9265 19.9265 20.3854 19.362 20.673C18.7202 21 17.8802 21 16.2 21H16" 
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Fullscreen
  </button>
  
  <button id="gamesBtn">
    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
 <path d="M5.99989 11H9.99989M7.99989 9V13M14.9999 12H15.0099M17.9999 10H18.0099M10.4488 5H13.5509C16.1758 5 17.4883 5 18.5184 5.49743C19.4254 5.9354 20.179 6.63709 20.6805 7.51059C21.2501 8.5027 21.3436 9.81181 21.5306 12.43L21.7766 15.8745C21.8973 17.5634 20.5597 19 18.8664 19C18.0005 19 17.1794 18.6154 16.6251 17.9502L16.2499 17.5C15.9068 17.0882 15.7351 16.8823 15.5398 16.7159C15.1302 16.3672 14.6344 16.1349 14.1043 16.0436C13.8514 16 13.5834 16 13.0473 16H10.9525C10.4164 16 10.1484 16 9.89553 16.0436C9.36539 16.1349 8.86957 16.3672 8.46 16.7159C8.26463 16.8823 8.09305 17.0882 7.74989 17.5L7.37473 17.9502C6.8204 18.6154 5.99924 19 5.13335 19C3.44013 19 2.1025 17.5634 2.22314 15.8745L2.46918 12.43C2.65619 9.81181 2.7497 8.5027 3.31926 7.51059C3.82074 6.63709 4.57433 5.9354 5.48135 5.49743C6.51151 5 7.82396 5 10.4488 5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
 </svg>
    Games
  </button>

  <button id="installAppBtn">
    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M21 21H3M18 11L12 17M12 17L6 11M12 17V3" 
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Download App
  </button>

  <div class="divider"></div>

  <button>
    <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M5 21V14M5 10V3M12 21V12M12 8V3M19 21V16M19 12V3M2 14H8M9 8H15M16 16H22" 
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Settings
  </button>
</div>

<div class="iframe-container" id="iframeContainer"></div>


<script>
if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');

let deferredPrompt, tabs = JSON.parse(localStorage.getItem('tabs')) || [{ name: 'New Tab', url: 'coolio://new', icon: 'img/logo.png' }],
    activeIndex = +localStorage.getItem('activeTab') || 0, iframeElements = [];

const $ = id => document.getElementById(id);
const tabsContainer = $('tabs'), urlInput = $('url-input'), iframeContainer = $('iframeContainer');

function formatURL(input) {
  if (input.startsWith('coolio://')) return input;
  return input.startsWith('http') ? input : (input.includes('.') ? 'https://' + input : 'https://duckduckgo.com/?q=' + encodeURIComponent(input));
}

function createIframe(tab, idx) {
  const iframe = document.createElement('iframe');
  
  if (tab.url === 'coolio://new') {
    iframe.src = 'newtab.html';
  } else {
    iframe.src = tab.url;
  }

  iframe.dataset.index = idx;
  iframe.classList.toggle('active', idx === activeIndex);

iframe.onload = () => {
  const thisIdx = parseInt(iframe.dataset.index, 10); // <--- Get it fresh when loaded
  const thisTab = tabs[thisIdx]; // <--- Always fresh
  
  if (!thisTab) return;

  try {
    if (thisTab.url.startsWith('coolio://')) {
      thisTab.name = 'New Tab';
      thisTab.icon = 'img/logo64x.png';
      saveAndRender();
    } else {
      const url = decodeURIComponent(thisTab.url.split('#')[1] || thisTab.url);
      const domain = (new URL(url)).hostname;
      thisTab.icon = `https://www.google.com/s2/favicons?domain=${domain}`;
      saveAndRender();

      const checkTitle = () => {
        try {
          const title = iframe.contentDocument?.title;
          if (title) {
            thisTab.name = title;
            saveAndRender();
          } else {
            setTimeout(checkTitle, 500);
          }
        } catch (e) {
          console.error('Error reading iframe title:', e);
          setTimeout(checkTitle, 500);
        }
      };

      setTimeout(checkTitle, 1500);
    }
  } catch (e) {
    console.error('Error updating tab info:', e);
  }
};

  iframeContainer.appendChild(iframe);
  iframeElements[idx] = iframe;
}


function renderTabs() {
  tabsContainer.innerHTML = '';
  tabs.forEach((tab, i) => {
    const el = document.createElement('div');
    el.className = 'tab' + (i === activeIndex ? ' selected' : '');

    const favIcon = document.createElement('img');
    favIcon.className = 'icon';
    favIcon.src = tab.icon || 'img/logo.png';

    const label = document.createElement('span');
    if (tab.name) {
      label.textContent = tab.name;
    } else {
      try {
        let realURL = decodeURIComponent(tab.url.split('#')[1] || tab.url);
        label.textContent = (new URL(realURL)).hostname.replace('www.', '');
      } catch {
        label.textContent = 'New Tab';
      }
    }

    const close = document.createElement('span');
    close.innerHTML = `<svg class="navb-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    close.className = 'close';
    close.onclick = e => {
      e.stopPropagation();
      iframeElements[i].remove();
      tabs.splice(i, 1);
      iframeElements.splice(i, 1);
      if (activeIndex >= tabs.length) activeIndex = tabs.length - 1;
      saveAndRender();
    };

    el.appendChild(favIcon);
    el.appendChild(label);
    el.appendChild(close);
    el.onclick = () => switchToTab(i);
    tabsContainer.appendChild(el);
  });

  const addTab = document.createElement('div');
  addTab.className = 'add-tab';
  addTab.innerHTML = `<svg class="navb-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  addTab.onclick = () => {
    const url = 'coolio://new';
    tabs.push({ name: 'New Tab', url, icon: 'img/logo.png' });
    activeIndex = tabs.length - 1;
    createIframe({ url }, activeIndex);
    saveAndRender();
  };
  tabsContainer.appendChild(addTab);
}

function switchToTab(idx) {
  activeIndex = idx;
  localStorage.setItem('activeTab', activeIndex);
  iframeElements.forEach((ifr, i) => ifr.classList.toggle('active', i === idx));
  if (iframeElements[idx]) {
    try {
      urlInput.value = decodeURIComponent(iframeElements[idx].src.split('#')[1] || iframeElements[idx].src);
    } catch {
      urlInput.value = iframeElements[idx].src;
    }
  }
  updateTabTitle(idx);
  renderTabs();
}

function saveAndRender() {
  localStorage.setItem('tabs', JSON.stringify(tabs));
  renderTabs();
  switchToTab(activeIndex);
}

function updateTabTitle(idx) {
  try {
    const title = iframeElements[idx].contentDocument.title;
    if (title && title !== tabs[idx].name) {
      tabs[idx].name = title;
      saveAndRender();
    }
  } catch {
    // Do nothing (likely cross-origin iframe)
  }
}

function updateTabIcons() {
  tabs.forEach((tab, i) => {
    try {
      const url = decodeURIComponent(tab.url.split('#')[1] || tab.url);
      tabs[i].icon = 'https://www.google.com/s2/favicons?domain=' + (new URL(url)).hostname;
    } catch {
      tabs[i].icon = 'img/logo.png';
    }
  });
  saveAndRender();
}

// Handle URL bar "Enter"
urlInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const formatted = formatURL(urlInput.value.trim());
    tabs[activeIndex].url = 'static/iframe.html#' + formatted;
    iframeElements[activeIndex].src = tabs[activeIndex].url;
    updateTabIcons();
  }
});

// Navigation buttons
$('backBtn').onclick = () => {
  try {
    iframeElements[activeIndex].contentWindow.history.back();
  } catch {}
};

$('forwardBtn').onclick = () => {
  try {
    iframeElements[activeIndex].contentWindow.history.forward();
  } catch {}
};

$('reloadBtn').onclick = () => {
  try {
    iframeElements[activeIndex].contentWindow.location.reload();
  } catch {}
};

// Dropdown handling
const moreButton = $('moreButton');
const dropdownMenu = $('dropdownMenu');

moreButton.onclick = () => {
  dropdownMenu.classList.toggle('show');
};

window.onclick = (e) => {
  if (!e.target.closest('.more-button') && !e.target.closest('.dropdown')) {
    dropdownMenu.classList.remove('show');
  }
};

// Fullscreen
$('fullscreenBtn').onclick = () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
};

// Install App
$('installAppBtn').onclick = () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(choiceResult => {
      deferredPrompt = null;
    });
  }
};

// New Tab Button
$('newTabBtn').onclick = () => {
  tabs.push({ name: 'New Tab', url: 'coolio://new', icon: 'img/logo.png' });
  activeIndex = tabs.length - 1;
  createIframe({ url: 'coolio://new' }, activeIndex);
  saveAndRender();
};

// Games Button
$('gamesBtn').onclick = () => {
  tabs.push({ name: 'Games', url: 'games.html', icon: 'img/logo.png' });
  activeIndex = tabs.length - 1;
  createIframe({ url: 'games.html' }, activeIndex);
  saveAndRender();
};

// Handle app install event
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
});

tabs.forEach(createIframe);
saveAndRender();
</script>

<script>
const topBar = document.getElementById('topBar');
const url = window.location.href;
if (url.includes('/newtab.html')) {
  topBar.textContent = 'coolio://new';
} else if (url.includes('/games.html')) {
  topBar.textContent = 'coolio://games';
} else {
  topBar.textContent = url;
}
</script>

</body>
</html>
